<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>è¿™ç®—å•¥å‘¢ã€‚ã€‚ä»¿å†™æ¸¸æˆç½‘é¡µ</title>
    <link rel="stylesheet" href="./style.css">
</head>
<body>
<header>
    <div class="logo"><img src="img/logo.png" height="49" width="156"/></div>
    <div class="login">
        <button style="background: darkorange;border-radius: 25px;height: 40px;width: 90px;border: none;color: white;margin-right:30px" id="showLoginBtn">ç™»å½•</button>
    </div>
</header>
<video autoplay muted loop>
    <source src="./video/WeGame_.mp4" type="video/mp4">
</video>
<main>
    <div>
        <div id="loginBox">
            <p class="login1">ç™»å½•</p>
            <div class="text1">
                <div class="loginimg1"></div><input type="text" class="login2" placeholder="QQ/é‚®ç®±"></div><br>
            <div class="text2">
                <div class="loginimg2"></div><input type="password" class="login3" placeholder="è¯·è¾“å…¥å¯†ç "></div><br>
            <div class="login4">
                <div class="mima"> <input type="checkbox" value="è®°ä½å¯†ç "><font color="#f5f5f5">è®°ä½å¯†ç </font></div>
                <div class="zhuce"><a href="" class="zhuce1">æ— æ³•ç™»å½•</a></div>
            </div>
            <div class="login5">
                <button id="loginBtn" style="text-decoration: none;color: white">ç™»å½•</button>
                <div id="errorMsg" class="error-message"></div>
            </div>
        </div>
    </div>
    <div id="registerBox" style="display: none;"> <!-- å¼ºåˆ¶åˆå§‹éšè— -->
        <p class="reg1">æ³¨å†Œ</p>
        <label>
            <input type="radio" name="role" value="user" checked>
            <div class="role-card">
              <div class="role-icon">ğŸ‘¤</div>
              <h3>æ™®é€šç©å®¶</h3>
              <p>æµè§ˆå’Œä½“éªŒæ¸¸æˆå†…å®¹</p>
            </div>
          </label>
          
          <label>
            <input type="radio" name="role" value="developer">
            <div class="role-card developer">
              <div class="role-icon">ğŸ‘¨ğŸ’»</div>
              <h3>æ¸¸æˆå¼€å‘è€…</h3>
              <p>å‘å¸ƒå’Œç®¡ç†æ¸¸æˆå†…å®¹</p>
            </div>
          </label>
        <div class="text1">
            <div class="loginimg1"></div>
            <input type="text" class="reg-user" placeholder="ç”¨æˆ·å">
        </div>
        <div class="text2">
            <div class="loginimg2"></div>
            <input type="password" class="reg-pwd" placeholder="å¯†ç ">
        </div><br>
        <div class="login4">
            <div class="mima"><font color="#f5f5f5">å·²æœ‰è´¦å·ï¼Ÿ</font></div>
            <div class="denglu"><a href="#" class="denglu1 switch-login">ç«‹å³ç™»å½•</a></div>
        </div>
        <div class="login5">
            <button id="regBtn">æ³¨å†Œ</button>
            <div id="regErrorMsg" class="error-message"></div>
        </div>
    </div>
</main>
<div id="successToast" class="toast-hidden">
    <div class="toast-content">
        <span>ğŸ‰ æ³¨å†ŒæˆåŠŸï¼</span>
    </div>
</div>
</body>
<script>
    // åœ¨æ‰€æœ‰å…¶ä»–ä»£ç ä¹‹å‰æ·»åŠ è·¯å¾„æ ‡å‡†åŒ–
(function fixPath() {
    if (window.location.pathname === '/' && 
        !window.location.href.includes('index.html')) {
        window.history.replaceState(null, '', '/index.html');
    }
})();
 // åˆå§‹åŒ–éšè—ç™»å½•æ¡†
 document.getElementById('loginBox').style.display = 'none';


    // æ–°å¢ç™»å½•åŠŸèƒ½
    document.getElementById('loginBtn').addEventListener('click', async () => {
    const username = document.querySelector('.login2').value.trim();
    const password = document.querySelector('.login3').value.trim();
    const errorMsg = document.getElementById('errorMsg');
    
    // æ¸…ç©ºæ—§æ¶ˆæ¯
    errorMsg.style.color = '#ff4444'; // æ–°å¢ï¼šå¼ºåˆ¶çº¢è‰²
    errorMsg.textContent = '';
    errorMsg.style.display = 'none';

    try {
        // 1. å‰ç«¯éªŒè¯
        if (!username || !password) {
            throw new Error('è¯·è¾“å…¥ç”¨æˆ·åå’Œå¯†ç ');
            // æŠ–åŠ¨åŠ¨ç”»æç¤º
            errorMsg.style.animation = 'shake 0.5s';
            setTimeout(() => errorMsg.style.animation = '', 500);
            window.errorTimer = setTimeout(() => {
                errorMsg.style.display = 'none';
            }, 2000);
            
            setTimeout(() => errorMsg.style.animation = '', 500);
        }

        // 2. å‘é€è¯·æ±‚
        const response = await fetch('http://localhost:3000/api/login', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ username, password })
        });

        const result = await response.json();

        // 3. å¤„ç†å“åº”
        if (response.ok) {
            localStorage.setItem('authToken', result.data.token);
            window.location.href = 'shouye.html'; // åŠ¨æ€è·³è½¬

        } else {
            errorMsg.textContent = result.message;
            errorMsg.style.display = 'block';
            // æŠ–åŠ¨åŠ¨ç”»æç¤º
            errorMsg.style.animation = 'shake 0.5s';
            setTimeout(() => errorMsg.style.animation = '', 500);
            window.errorTimer = setTimeout(() => {
                errorMsg.style.display = 'none';
            }, 2000);
            
            setTimeout(() => errorMsg.style.animation = '', 500);
        }
    } catch (error) {
        errorMsg.style.color = '#ff4444'; // æ–°å¢
        errorMsg.textContent = error.message || 'ç½‘ç»œè¿æ¥å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œ';
        errorMsg.style.display = 'block';

        // æ–°å¢è‡ªåŠ¨æ¶ˆå¤±é€»è¾‘
        errorMsg.style.animation = 'shake 0.5s';
        setTimeout(() => errorMsg.style.animation = '', 500);
        window.errorTimer = setTimeout(() => {
        errorMsg.style.display = 'none';
        }, 2000);
    }
    // setTimeout(() => errorMsg.style.animation = '', 500);
});

// ç™»é™†çŠ¶æ€éªŒè¯



// ä¿®æ”¹åçš„ç™»å½•çŠ¶æ€éªŒè¯ï¼ˆçº¦ç¬¬140è¡Œï¼‰
if (!localStorage.getItem('authToken') && 
    window.location.pathname !== '/index.html' && 
    window.location.pathname !== '/') {
    window.location.href = '/index.html';
}
// æ”¹è¿›çš„åˆ‡æ¢å‡½æ•°
function toggleForms(hideId, showId) {
    if (hideId) {
        const hideElement = document.getElementById(hideId);
        hideElement.style.opacity = 0;
        setTimeout(() => {
            hideElement.style.display = 'none';
        }, 300);
    }

    const showElement = document.getElementById(showId);
    showElement.style.display = 'block';
    setTimeout(() => {
        showElement.style.opacity = 1;
    }, 50);
}

// ç•Œé¢åˆ‡æ¢äº‹ä»¶ç»‘å®š
document.querySelector('a.zhuce1').addEventListener('click', function(e) {
    e.preventDefault();
    toggleForms('loginBox', 'registerBox');
    document.getElementById('errorMsg').style.display = 'none';
                            // æ¸…ç©ºç™»å½•ä¿¡æ¯
            document.querySelector('.login2').value = '';
            document.querySelector('.login3').value = '';
});

document.querySelector('.switch-login').addEventListener('click', function(e) {
    e.preventDefault();
    toggleForms('registerBox', 'loginBox');
                // æ¸…ç©ºæ³¨å†Œä¿¡æ¯
            document.querySelector('.reg-user').value = '';
            document.querySelector('.reg-pwd').value = '';
});

// é¡¶éƒ¨ç™»å½•æŒ‰é’®äº‹ä»¶
document.getElementById('showLoginBtn').addEventListener('click', function(e) {
    e.preventDefault();
    toggleForms(null, 'loginBox');
});

// æ³¨å†ŒåŠŸèƒ½ï¼ˆä¿®æ”¹åï¼‰
// ä¿®æ”¹æ³¨å†ŒåŠŸèƒ½éƒ¨åˆ†
document.getElementById('regBtn').addEventListener('click', async () => {
    const username = document.querySelector('.reg-user').value.trim();
    const password = document.querySelector('.reg-pwd').value.trim();
    const role = document.querySelector('input[name="role"]:checked').value;
    const errorMsg = document.getElementById('regErrorMsg');

    errorMsg.textContent = '';
    errorMsg.style.display = 'none';

    try {
        if (!/^[a-zA-Z0-9]{4,16}$/.test(username)) {
            errorMsg.textContent = 'ç”¨æˆ·åéœ€4-16ä½å­—æ¯æ•°å­—';
            errorMsg.style.display = 'block';
            errorMsg.style.animation = 'shake 0.5s';
        return;
    }

    if (password.length < 8) {
        errorMsg.textContent = 'å¯†ç è‡³å°‘8ä½';
        errorMsg.style.display = 'block';
        return;
    }

        if (!username || !password) {
            throw new Error('ç”¨æˆ·åå’Œå¯†ç ä¸èƒ½ä¸ºç©º');
        }

        const response = await fetch('http://localhost:3000/api/register', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ username, password, role }) // åŒ…å«roleå‚æ•°
        });

        const result = await response.json();

        if (response.ok) {
            // æ˜¾ç¤ºæˆåŠŸå¼¹çª—å¹¶åˆ‡æ¢ç•Œé¢
            const toast = document.getElementById('successToast');
            toast.style.opacity = 1;
            toast.style.visibility = 'visible';
            setTimeout(() => {
                toast.style.opacity = 0;
                toast.style.visibility = 'hidden';
            }, 3000);

            toggleForms('registerBox', 'loginBox');
            
            // æ¸…ç©ºæ³¨å†Œä¿¡æ¯
            document.querySelector('.reg-user').value = '';
            document.querySelector('.reg-pwd').value = '';
            
            // åœ¨ç™»å½•æ¡†æ˜¾ç¤ºæˆåŠŸæç¤º
            const loginErrorMsg = document.getElementById('errorMsg');
            // loginErrorMsg.style.color = 'green';
            // loginErrorMsg.textContent = 'æ³¨å†ŒæˆåŠŸï¼Œè¯·ç™»å½•';
            loginErrorMsg.style.display = 'block';
        } else {
            errorMsg.textContent = result.message;
            errorMsg.style.display = 'block';
            errorMsg.style.animation = 'shake 0.5s';
            setTimeout(() => errorMsg.style.animation = '', 500);
            window.errorTimer = setTimeout(() => {
                errorMsg.style.display = 'none';
            }, 2000);
            
            setTimeout(() => errorMsg.style.animation = '', 500);
        }
    } catch (error) {
        errorMsg.textContent = error.message || 'æ³¨å†Œå¤±è´¥ï¼Œè¯·é‡è¯•';
        errorMsg.style.display = 'block';
        errorMsg.style.animation = 'shake 0.5s';
            setTimeout(() => errorMsg.style.animation = '', 500);
            window.errorTimer = setTimeout(() => {
                errorMsg.style.display = 'none';
            }, 2000);
            
    }
});
if (!window.localStorage) {
  alert("è¯·å‡çº§æµè§ˆå™¨æˆ–ç¦ç”¨éšç§æ¨¡å¼");
}
document.querySelectorAll('.role-card').forEach(card => {
    card.addEventListener('click', function() {
        document.querySelectorAll('.role-card').forEach(c => c.classList.remove('selected'));
        this.classList.add('selected');
    });
});
</script>
</html>