<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>å…ˆé”‹æµ‹è¯•</title>
    <link rel="stylesheet" href="./ceshi.css">
</head>
<body>
  <header>
    <div class="logo"><img src="img/logo.png" height="49" width="156"/></div>
    <div class="topbq">
        <ul>
            <li><a href="#" class="top-bq">é¢„çº¦</a></li>
            <li><a href="ceshi.html" class="top-bq" style="color: orange">è®¢é˜…</a></li>
            <li><a href="#" class="top-bq">ç¤¾åŒº</a></li>
            <li class="dropdown-container">
                <a href="#" class="top-bq">æ›´å¤š â–¼</a>
                <div class="dropdown-menu">
                    <div class="dropdown-item" onclick="showNotifications()">ğŸ“© é€šçŸ¥</div>
                    <div class="dropdown-item" onclick="showSettings()">âš™ï¸ è®¾ç½®</div>
                    <!-- å¼€å‘è€…ä¸“å± -->
                    <div class="dev-item" onclick="checkDeveloperAccess(event)">ğŸ’» å¼€å‘è€…ä¸­å¿ƒ</div>
                </div>
            </li>
        </ul>
    </div>
    <div class="search-bar">
        <input type="text" placeholder="æœç´¢..." style="height: 30px;width: 350px;border-top-left-radius: 15px;border-bottom-left-radius: 15px;border: none;background: whitesmoke">
        <button style="margin-left:-10px;height: 40px;width: 60px;border-bottom-right-radius:15px;border-top-right-radius:15px;border: none;background: whitesmoke;color: black ">æœç´¢</button>
    </div>
    <div class="login">
        <a href="library.html">
        <button type="download"  >æˆ‘çš„æ¸¸æˆåº“</button>
        </a>
    </div>
</header>

<div style="height: 65px;width: 100%"></div>
<div class="body">
    <img src="img/ceshiboy.png">
    <div class="body1">
        <div class="b1">
            <div class="b1a"><font size="3" color="#d3d3d3">æäº¤æµ‹è¯•æ¸¸æˆè¯¦æƒ…</font>&nbsp;&nbsp;&nbsp;&nbsp;<input type="text" placeholder="æœç´¢..."></div>
            <div class="b1b"><img src="img/ceshilogo.png" height="60" width="245"/></div>
            <div class="b1c"><font size="5" color="#f5f5f5"><b>æ–°é²œè¯•ç©</b> </font></div>
        </div>
        <div class="b2">
            <div class="b2-1">
                <img id="image" src="img/b2-1.png" height="436" width="772"/>
                <br>
                <b><font id="text" size="4">å¼¹ç åœ°ç‹±æ´›åå¡”</font></b>
                <br><br>
                <font size="4">è¯„åˆ†ï¼š</font><b><font id="text2" size="4" color="orange">6.1/10.0</font></b>                <button type="buy">é©¬ä¸Šå¼€æŠ¢</button>
                <br>
                <b><font size="4"color="gray">æ›´å¤šä¿¡æ¯è¯·æŒç»­å…³æ³¨æœ¬å¹³å°ï¼Œæœ¬å¹³å°ä¼šç¬¬ä¸€æ—¶é—´ä¸ºæ‚¨æ¨é€...</font></b>

            </div>
            <div class="b2-2">
                <div class="b2-2a"><button onclick="changeContent(1) " type="btn"><img src="img/btn1.png" height="102" width="215"/></button></div>
                <div class="b2-2a"><button onclick="changeContent(2) " type="btn"><img src="img/btn2.jpg" height="102" width="215"/></button></div>
                <div class="b2-2a"><button onclick="changeContent(3) " type="btn"><img src="img/btn3.png" height="102" width="215"/></button></div>
                <div class="b2-2a"><button onclick="changeContent(4) " type="btn"><img src="img/btn4.jpg" height="102" width="215"/></button></div>
                <div class="b2-2a"><button onclick="changeContent(5) " type="btn"><img src="img/btn5.png" height="102" width="215"/></button></div>
            </div>
        </div>
        <div class="b3a">

            <div class="b3">
    
                    <div class="b3-date1">
                        <div class="b3-date2">æ¸¸æˆè®¢é˜…</div>
                    </div>
                <div class="b3-2">
                    <!-- <div class="b3-2a">
                        <div class="b3-2a1"><img src="img/dingyue1.png" height="192" width="305"/></div>
                        <div class="b3-2a2">                        </div>
                        <div class="b3-2a3">
                            <button type="dingyue" id="reserve-button">äº†è§£æ›´å¤š</button>
                            <button type="dingyue" id="reserve-button">ç«‹å³è®¢é˜…</button>
                        </div>
                    </div> -->
                    <div class="b3-2a">
                        <div class="b3-2a1"><img src="img/dingyue1.png" height="192" width="305"/></div>
                        <div class="b3-2a2">                        </div>
                        <div class="b3-2a3">
                            <button type="dingyue" id="reserve-button">äº†è§£æ›´å¤š</button>
                            <button type="dingyue" 
                                    class="subscribe-btn"
                                    data-game-id="game1" 
                                    data-game-name="æ³¡æ³¡å¹¸å­˜è€…">
                              ç«‹å³è®¢é˜…
                            </button>
                        </div>
                    </div>
                    
                </div>
                <div class="b3-2">
                  <div class="b3-2a">
                    <div class="b3-2a1"><img src="img/dingyue2.png" height="192" width="305"/></div>
                    <div class="b3-2a2">                        </div>
                    <div class="b3-2a3">
                        <button type="dingyue" id="reserve-button">äº†è§£æ›´å¤š</button>
                        <button type="dingyue" 
                                class="subscribe-btn"
                                data-game-id="game2" 
                                data-game-name="ç«ç§è®¡åˆ’">
                          ç«‹å³è®¢é˜…
                        </button>
                    </div>
                  </div>
                </div>
                <div class="b3-2">
                  <div class="b3-2a">
                    <div class="b3-2a1"><img src="img/dingyue3.png" height="192" width="305"/></div>
                    <div class="b3-2a2">                        </div>
                    <div class="b3-2a3">
                        <button type="dingyue" id="reserve-button">äº†è§£æ›´å¤š</button>
                        <button type="dingyue" 
                                class="subscribe-btn"
                                data-game-id="game3" 
                                data-game-name="é¾™åŸç«‹å¿—ä¼ ">
                          ç«‹å³è®¢é˜…
                        </button>
                    </div>
                  </div>
                </div>
                <div class="b3-2" id="subscribedGamesContainer"></div>
            </div>
        </div>
    </div>

</div>
<div id="accessDeniedToast" style="display: none;">
  å½“å‰è´¦å·æ— å¼€å‘è€…æƒé™ï¼
</div>
</body>
<script>
    function changeContent(buttonIndex) {
        const image = document.getElementById('image');
        const text = document.getElementById('text');
        const text2 = document.getElementById('text2');
        const buttons = document.querySelectorAll('.b2-2a');

        // æ”¹å˜æ–‡æœ¬å’Œå›¾ç‰‡
        switch (buttonIndex) {
            case 1:
                image.src = './img/b2-1.png';
                text.innerText = 'å¼¹ç åœ°ç‹±æ´›åå¡”';
                text2.innerText = '6.1/10.0';
                break;
            case 2:
                image.src = './img/b2-2.png';
                text.innerText = 'å¢¨å¢ƒ';
                text2.innerText = '8.9/10.0';
                break;
            case 3:
                image.src = './img/b2-3.png';
                text.innerText = 'èŒåœºæµ®ç”Ÿè®°';
                text2.innerText = '5.4/10.0';
                break;
            case 4:
                image.src = './img/b2-4.png';
                text.innerText = 'åŠ¨ç‰©æ ï¼šæ¡Œé¢ç‰§åœº';
                text2.innerText = '7.8/10.0';
                break;
            case 5:
                image.src = './img/b2-5.png';
                text.innerText = 'ç ´ç¢è”ç›Ÿ';
                text2.innerText = '7.1/10.0';
                break;
        }
        // ç§»é™¤æ‰€æœ‰æŒ‰é’®çš„æ´»è·ƒçŠ¶æ€
        buttons.forEach(button => {
            button.classList.remove('active');
        });

        // æ·»åŠ æ´»è·ƒçŠ¶æ€åˆ°å½“å‰æŒ‰é’®
        buttons[buttonIndex - 1].classList.add('active');
    }


    async function loadSubscribedGames() {
    try {
        const response = await fetch('/api/games/approved?type=subscribe');
        const games = await response.json();
        
        const container = document.getElementById('subscribedGamesContainer');
        container.innerHTML = '';
        
        games.forEach(game => {
            const gameHTML = `
                <div class="b3-2a">
                    <div class="b3-2a1">
                        <img src="${game.cover}" height="192" width="305"/>
                    </div>
                    <div class="b3-2a3">
                        <button type="dingyue">äº†è§£æ›´å¤š</button>
                        <button type="dingyue" 
                                class="subscribe-btn"
                                data-game-id="${game.id}" 
                                data-game-name="${game.title}">
                            ç«‹å³è®¢é˜…
                        </button>
                    </div>
                </div>
            `;
            container.insertAdjacentHTML('beforeend', gameHTML);
        });
        
        initSubscribeButtons();
    } catch (error) {
        console.error('åŠ è½½è®¢é˜…æ¸¸æˆå¤±è´¥:', error);
    }
}

// é¡µé¢åŠ è½½æ—¶è°ƒç”¨
document.addEventListener('DOMContentLoaded', () => {
    loadSubscribedGames();
    // ä¿æŒåŸæœ‰å…¶ä»–åˆå§‹åŒ–...
});
  // ä¿®æ”¹æ£€æŸ¥å¼€å‘è€…æƒé™çš„æ–¹æ³•
  function checkDeveloperAccess(event) {
    event.preventDefault();
    const token = localStorage.getItem('authToken');
    
    if (!token) {
        showCustomAlert('âš ï¸ è¯·å…ˆç™»å½•', 'æ‚¨éœ€è¦ç™»å½•åæ‰èƒ½è®¿é—®å¼€å‘è€…ä¸­å¿ƒ');
        return;
    }

    fetch('/api/check-developer', {
        headers: { 'Authorization': `Bearer ${token}` }
    })
    .then(response => {
        if (response.status === 200) {
            window.location.href = 'kaifa.html';
        } else if (response.status === 403) {
            showAccessDeniedToast(); // æ–°å¢ä¸“ç”¨æç¤ºæ–¹æ³•
        } else {
            showCustomAlert('é”™è¯¯', 'æœªçŸ¥é”™è¯¯ï¼ŒçŠ¶æ€ç ï¼š' + response.status);
        }
    })
    .catch(error => {
        console.error('æƒé™éªŒè¯å¤±è´¥:', error);
        showCustomAlert('é”™è¯¯', 'ç½‘ç»œè¿æ¥å¼‚å¸¸ï¼Œè¯·ç¨åé‡è¯•');
    });
}

// æ–°å¢ä¸“ç”¨æƒé™æç¤º
function showAccessDeniedToast() {
    const toast = document.getElementById('accessDeniedToast');
    toast.style.display = 'block';
    setTimeout(() => {
        toast.style.display = 'none';
    }, 2000);
}
        // ====================== æ–°å¢ Toast æç¤ºç»„ä»¶ ====================== 
const Toast = {
  show: (message, isSuccess = true) => {
    const toast = document.createElement('div');
    toast.className = `custom-toast ${isSuccess ? 'success' : 'error'}`;
    toast.innerHTML = `
      <span>${isSuccess ? 'âœ…' : 'âš ï¸'}</span>
      <p>${message}</p>
    `;
    document.body.appendChild(toast);
    
    setTimeout(() => toast.classList.add('show'), 10);
    setTimeout(() => {
      toast.classList.remove('show');
      setTimeout(() => toast.remove(), 300);
    }, 2000);
  }
};

// ====================== è®¢é˜…æ ¸å¿ƒé€»è¾‘ ======================
const handleSubscribe = async (button) => {
  const gameId = button.dataset.gameId;
  const gameName = button.dataset.gameName;
  const isSubscribed = button.textContent.includes('å·²è®¢é˜…');

  try {
    const response = await fetch('/api/subscribe', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'Authorization': `Bearer ${localStorage.getItem('authToken')}`
      },
      body: JSON.stringify({
        gameId,
        gameName,  // æ·»åŠ æ¸¸æˆåç§°å‚æ•°
        action: isSubscribed ? 'remove' : 'add'
      })
    });

    if (!response.ok) throw new Error('æ“ä½œå¤±è´¥');
    
    button.textContent = isSubscribed ? 'ç«‹å³è®¢é˜…' : 'å·²è®¢é˜…';
    button.style.backgroundColor = isSubscribed ? '#6c757d' : '#ff6b6b';
    Toast.show(isSubscribed ? `å·²å–æ¶ˆè®¢é˜… ${gameName}` : `æˆåŠŸè®¢é˜… ${gameName}`);
  } catch (error) {
    Toast.show(error.message || 'ç½‘ç»œé”™è¯¯ï¼Œè¯·é‡è¯•', false);
  }
};

// ====================== åˆå§‹åŒ–è®¢é˜…æŒ‰é’®çŠ¶æ€ ======================
const initSubscribeButtons = async () => {
  try {
    const response = await fetch('/api/library', {
      headers: {
        'Authorization': `Bearer ${localStorage.getItem('authToken')}`
      }
    });
    
    const { subscriptions } = await response.json();
    document.querySelectorAll('.subscribe-btn').forEach(button => {
      const gameId = button.dataset.gameId;
      const isSubscribed = subscriptions.some(s => s.id === gameId);
      
      if (isSubscribed) {
        button.textContent = 'å·²è®¢é˜…';
        button.style.backgroundColor = '#ff6b6b';
      }
    });
  } catch (error) {
    Toast.show('åˆå§‹åŒ–è®¢é˜…æ•°æ®å¤±è´¥', false);
  }
};

// äº‹ä»¶ç»‘å®š
document.querySelectorAll('.subscribe-btn').forEach(button => {
  button.addEventListener('click', () => handleSubscribe(button));
});

// é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–
document.addEventListener('DOMContentLoaded', initSubscribeButtons);
</script>
</html>